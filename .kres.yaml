kind: golang.Generate
spec:
  versionPackagePath: internal/version
---
kind: golang.GoVulnCheck
spec:
  ignore: []
---
kind: golang.Build
spec:
  outputs:
    linux-amd64:
      GOOS: linux
      GOARCH: amd64
    linux-arm64:
      GOOS: linux
      GOARCH: arm64
---
kind: golang.Toolchain
spec:
  makefile:
    extraVariables:
      - name: PKGS_PREFIX
        defaultValue: ghcr.io/siderolabs
      - name: PKGS
        defaultValue: v1.13.0-alpha.0-35-g375983f
  docker:
    extraArgs:
      - PKGS_PREFIX
      - PKGS
  buildTags:
    - enterprise
---
kind: common.Docker
spec:
  extraBuildArgs:
    - PKGS_PREFIX
    - PKGS
---
kind: common.Image
name: image-image-factory
spec:
  extraEnvironment:
    PLATFORM: linux/amd64,linux/arm64
  environment:
    TUF_ROOT: /tmp
  additionalImages: [] # so we copy same fhs and ca-certificates as the version of other tools
  allowedLocalPaths:
    - tailwind.config.js
    - package.json
    - package-lock.json
  dependsOn:
    - tailwind
  entrypoint: /usr/bin/image-factory
  copyFrom:
    - name: imager-tools
      stage: imager-tools
---
kind: auto.CustomSteps
spec:
  steps:
    - name: imager-base
      toplevel: true
    - name: imager-tools
      toplevel: true
    - name: integration.test
      toplevel: true
    - name: integration.enterprise.test
      toplevel: true
    - name: integration-direct
      toplevel: true
      dependants:
        - coverage
    - name: integration-s3
      toplevel: true
      dependants:
        - coverage
    - name: integration-cdn
      toplevel: true
      dependants:
        - coverage
    - name: integration-proxy-installer
      toplevel: true
      dependants:
        - coverage
    - name: integration-enterprise
      toplevel: true
      dependants:
        - coverage
    - name: update-to-talos-main
      toplevel: true
    - name: integration-cdn-talos-main
      toplevel: true
    - name: integration-direct-talos-main
      toplevel: true
    - name: integration-s3-talos-main
      toplevel: true
    - name: tailwind
      toplevel: true
    - name: docs
      toplevel: true
    - name: check-dirty
      toplevel: true
    - name: docker-compose-up
      toplevel: true
    - name: docker-compose-down
      toplevel: true
---
kind: custom.Step
name: imager-base
spec:
  makefile:
    enabled: true
    phony: true
  docker:
    enabled: true
    stages:
      - name: pkg-fhs
        from: ${PKGS_PREFIX}/fhs:${PKGS}
      - name: pkg-ca-certificates
        from: ${PKGS_PREFIX}/ca-certificates:${PKGS}
      - name: pkg-musl
        from: ${PKGS_PREFIX}/musl:${PKGS}
      - name: pkg-cpio
        from: ${PKGS_PREFIX}/cpio:${PKGS}
      - name: pkg-dosfstools
        from: ${PKGS_PREFIX}/dosfstools:${PKGS}
      - name: pkg-grub
        from: ${PKGS_PREFIX}/grub:${PKGS}
      - name: pkg-grub-amd64
        from: ${PKGS_PREFIX}/grub:${PKGS}
        platform: linux/amd64
      - name: pkg-grub-arm64
        from: ${PKGS_PREFIX}/grub:${PKGS}
        platform: linux/arm64
      - name: pkg-grub-unicode
        from: ${PKGS_PREFIX}/installer:v1.9.4
      - name: pkg-kmod
        from: ${PKGS_PREFIX}/kmod:${PKGS}
      - name: pkg-libarchive
        from: ${PKGS_PREFIX}/libarchive:${PKGS}
      - name: pkg-libattr
        from: ${PKGS_PREFIX}/libattr:${PKGS}
      - name: pkg-libinih
        from: ${PKGS_PREFIX}/libinih:${PKGS}
      - name: pkg-liblzma
        from: ${PKGS_PREFIX}/liblzma:${PKGS}
      - name: pkg-liburcu
        from: ${PKGS_PREFIX}/liburcu:${PKGS}
      - name: pkg-openssl
        from: ${PKGS_PREFIX}/openssl:${PKGS}
      - name: pkg-open-vmdk
        from: ${PKGS_PREFIX}/open-vmdk:${PKGS}
      - name: pkg-xfsprogs
        from: ${PKGS_PREFIX}/xfsprogs:${PKGS}
      - name: pkg-e2fsprogs
        from: ${PKGS_PREFIX}/e2fsprogs:${PKGS}
      - name: pkg-glib
        from: ${PKGS_PREFIX}/glib:${PKGS}
      - name: pkg-libburn
        from: ${PKGS_PREFIX}/libburn:${PKGS}
      - name: pkg-libisoburn
        from: ${PKGS_PREFIX}/libisoburn:${PKGS}
      - name: pkg-libisofs
        from: ${PKGS_PREFIX}/libisofs:${PKGS}
      - name: pkg-mtools
        from: ${PKGS_PREFIX}/mtools:${PKGS}
      - name: pkg-pcre2
        from: ${PKGS_PREFIX}/pcre2:${PKGS}
      - name: pkg-pigz
        from: ${PKGS_PREFIX}/pigz:${PKGS}
      - name: pkg-qemu-tools
        from: ${PKGS_PREFIX}/qemu-tools:${PKGS}
      - name: pkg-squashfs-tools
        from: ${PKGS_PREFIX}/squashfs-tools:${PKGS}
      - name: pkg-tar
        from: ${PKGS_PREFIX}/tar:${PKGS}
      - name: pkg-xz
        from: ${PKGS_PREFIX}/xz:${PKGS}
      - name: pkg-zlib
        from: ${PKGS_PREFIX}/zlib:${PKGS}
      - name: pkg-zstd
        from: ${PKGS_PREFIX}/zstd:${PKGS}
---
kind: custom.Step
name: imager-tools
spec:
  makefile:
    enabled: true
    phony: true
  docker:
    enabled: true
    stages:
      - name: imager-tools
        description: copies the imager tools
        steps:
          - copy:
              from: pkg-fhs
              src: /
              dst: /
          - copy:
              from: pkg-ca-certificates
              src: /
              dst: /
          - copy:
              from: pkg-musl
              src: /
              dst: /
          - copy:
              from: pkg-cpio
              src: /
              dst: /
          - copy:
              from: pkg-dosfstools
              src: /
              dst: /
          - copy:
              from: pkg-grub
              src: /
              dst: /
          - copy:
              from: pkg-grub-amd64
              src: /usr/lib/grub
              dst: /usr/lib/grub
          - copy:
              from: pkg-grub-arm64
              src: /usr/lib/grub
              dst: /usr/lib/grub
          - copy:
              from: pkg-grub-unicode
              src: /usr/share/grub/unicode.pf2
              dst: /usr/share/grub/unicode.pf2
          - copy:
              from: pkg-kmod
              src: /
              dst: /
          - copy:
              from: pkg-libarchive
              src: /
              dst: /
          - copy:
              from: pkg-libattr
              src: /
              dst: /
          - copy:
              from: pkg-libinih
              src: /
              dst: /
          - copy:
              from: pkg-liblzma
              src: /
              dst: /
          - copy:
              from: pkg-liburcu
              src: /
              dst: /
          - copy:
              from: pkg-openssl
              src: /
              dst: /
          - copy:
              from: pkg-open-vmdk
              src: /
              dst: /
          - copy:
              from: pkg-xfsprogs
              src: /
              dst: /
          - copy:
              from: pkg-e2fsprogs
              src: /
              dst: /
          - copy:
              from: pkg-glib
              src: /
              dst: /
          - copy:
              from: pkg-libburn
              src: /
              dst: /
          - copy:
              from: pkg-libisoburn
              src: /
              dst: /
          - copy:
              from: pkg-libisofs
              src: /
              dst: /
          - copy:
              from: pkg-mtools
              src: /
              dst: /
          - copy:
              from: pkg-pcre2
              src: /
              dst: /
          - copy:
              from: pkg-pigz
              src: /
              dst: /
          - copy:
              from: pkg-qemu-tools
              src: /
              dst: /
          - copy:
              from: pkg-squashfs-tools
              src: /
              dst: /
          - copy:
              from: pkg-tar
              src: /
              dst: /
          - copy:
              from: pkg-xz
              src: /
              dst: /
          - copy:
              from: pkg-zlib
              src: /
              dst: /
          - copy:
              from: pkg-zstd
              src: /
              dst: /
---
kind: custom.Step
name: integration.test
spec:
  docker:
    enabled: true
    stages:
      - name: integration-build
        description: builds the integration test binary
        from: base
        steps:
          - script:
              command: go test -c -covermode=atomic -coverpkg=./... -tags integration ./internal/integration
              cache:
                - /root/.cache/go-build
                - /go/pkg
      - name: integration.test
        description: copies out the integration test binary
        steps:
          - copy:
              from: integration-build
              src: /src/integration.test
              dst: /integration.test
  makefile:
    enabled: true
    phony: true
    script:
      - "@$(MAKE) local-$@ DEST=$(ARTIFACTS)"
---
kind: custom.Step
name: integration.enterprise.test
spec:
  docker:
    enabled: true
    stages:
      - name: integration-enterprise-build
        description: builds the integration test binary (Enterprise flavor)
        from: base
        steps:
          - script:
              command: go test -c -covermode=atomic -coverpkg=./... -tags integration,enterprise ./internal/integration
              cache:
                - /root/.cache/go-build
                - /go/pkg
      - name: integration.enterprise.test
        description: copies out the integration test binary
        steps:
          - copy:
              from: integration-enterprise-build
              src: /src/integration.test
              dst: /integration.enterprise.test
  makefile:
    enabled: true
    phony: true
    script:
      - "@$(MAKE) local-$@ DEST=$(ARTIFACTS)"
---
kind: custom.Step
name: update-to-talos-main
spec:
  docker:
    enabled: true
    stages:
      - name: update-to-talos-main
        description: updates go.mod to use the latest talos main
        from: base
        steps:
          - script:
              command: go get -u github.com/siderolabs/talos@main
              cache:
                - /root/.cache/go-build
                - /go/pkg
          - script:
              command: go get -u github.com/siderolabs/talos/pkg/machinery@main
              cache:
                - /root/.cache/go-build
                - /go/pkg
      - name: copy-out-go-mod
        description: copies out the go.mod and go.sum
        steps:
          - copy:
              from: update-to-talos-main
              src: /src/go.mod
              dst: /go.mod
          - copy:
              from: update-to-talos-main
              src: /src/go.sum
              dst: /go.sum
  makefile:
    enabled: true
    phony: true
    script:
      - '@$(MAKE) local-copy-out-go-mod DEST=. TARGET_ARGS="--no-cache-filter=update-to-talos-main"'
---
kind: custom.Step
name: integration-direct
spec:
  makefile:
    enabled: true
    phony: true
    depends:
      - integration.test
    variables:
      - name: RUN_TESTS_DIRECT
        defaultValue: TestIntegrationDirect
      - name: TEST_FLAGS
        defaultValue: ""
    script:
      - "@$(MAKE) image-image-factory PUSH=true"
      - docker pull $(REGISTRY)/$(USERNAME)/image-factory:$(TAG)
      - docker rm -f local-if || true
      - docker run -d -p 5100:5000 --name=local-if registry:3
      - docker run --rm --net=host -v /var/run:/var/run -v $(PWD)/$(ARTIFACTS)/:/out/ -v $(PWD)/$(ARTIFACTS)/integration.test:/bin/integration.test:ro --entrypoint /bin/integration.test $(REGISTRY)/$(USERNAME)/image-factory:$(TAG) -test.v $(TEST_FLAGS) -test.coverprofile=/out/coverage-integration-direct.txt -test.run $(RUN_TESTS_DIRECT)
      - docker rm -f local-if
  ghaction:
    enabled: true
    condition: on-pull-request
    parallelJob:
      name: integration-direct
      runnerGroup: generic
    coverage:
      inputPaths:
        - coverage-integration-direct.txt
    environment:
      REGISTRY: registry.dev.siderolabs.io
      RUN_TESTS_DIRECT: TestIntegrationDirect
      TEST_FLAGS: "-test.schematic-service-repository=127.0.0.1:5100/image-factory/schematic -test.installer-external-repository=127.0.0.1:5100/siderolabs -test.installer-internal-repository=127.0.0.1:5100/siderolabs -test.cache-repository=127.0.0.1:5100/image-factory/cache -test.signing-cache-repository=127.0.0.1:5100/image-factory/signing-cache"
---
kind: custom.Step
name: integration-s3
spec:
  makefile:
    enabled: true
    phony: true
    depends:
      - integration.test
    variables:
      - name: RUN_TESTS_S3
        defaultValue: TestIntegrationS3
      - name: TEST_FLAGS
        defaultValue: ""
    script:
      - "@$(MAKE) image-image-factory PUSH=true"
      - docker pull $(REGISTRY)/$(USERNAME)/image-factory:$(TAG)
      - docker rm -f local-if || true
      - docker run -d -p 5100:5000 --name=local-if registry:3
      - docker run --rm --net=host -v /var/run:/var/run -v $(PWD)/$(ARTIFACTS)/:/out/ -v $(PWD)/$(ARTIFACTS)/integration.test:/bin/integration.test:ro --entrypoint /bin/integration.test $(REGISTRY)/$(USERNAME)/image-factory:$(TAG) -test.v $(TEST_FLAGS) -test.coverprofile=/out/coverage-integration-s3.txt -test.run $(RUN_TESTS_S3)
      - docker rm -f local-if
  ghaction:
    enabled: true
    condition: on-pull-request
    parallelJob:
      name: integration-s3
      runnerGroup: generic
    coverage:
      inputPaths:
        - coverage-integration-s3.txt
    environment:
      REGISTRY: registry.dev.siderolabs.io
      RUN_TESTS: TestIntegrationS3
      TEST_FLAGS: "-test.schematic-service-repository=127.0.0.1:5100/image-factory/schematic -test.installer-external-repository=127.0.0.1:5100/siderolabs -test.installer-internal-repository=127.0.0.1:5100/siderolabs -test.cache-repository=127.0.0.1:5100/image-factory/cache -test.signing-cache-repository=127.0.0.1:5100/image-factory/signing-cache"
---
kind: custom.Step
name: integration-cdn
spec:
  makefile:
    enabled: true
    phony: true
    depends:
      - integration.test
    variables:
      - name: RUN_TESTS_CDN
        defaultValue: TestIntegrationCDN
      - name: TEST_FLAGS
        defaultValue: ""
    script:
      - "@$(MAKE) image-image-factory PUSH=true"
      - docker pull $(REGISTRY)/$(USERNAME)/image-factory:$(TAG)
      - docker rm -f local-if || true
      - docker run -d -p 5100:5000 --name=local-if registry:3
      - docker run --rm --net=host -v /var/run:/var/run -v $(PWD)/$(ARTIFACTS)/:/out/ -v $(PWD)/$(ARTIFACTS)/integration.test:/bin/integration.test:ro --entrypoint /bin/integration.test $(REGISTRY)/$(USERNAME)/image-factory:$(TAG) -test.v $(TEST_FLAGS) -test.coverprofile=/out/coverage-integration-cdn.txt -test.run $(RUN_TESTS_CDN)
      - docker rm -f local-if
  ghaction:
    enabled: true
    condition: on-pull-request
    parallelJob:
      name: integration-cdn
      runnerGroup: generic
    coverage:
      inputPaths:
        - coverage-integration-cdn.txt
    environment:
      REGISTRY: registry.dev.siderolabs.io
      RUN_TESTS_CDN: TestIntegrationCDN
      TEST_FLAGS: "-test.schematic-service-repository=127.0.0.1:5100/image-factory/schematic -test.installer-external-repository=127.0.0.1:5100/siderolabs -test.installer-internal-repository=127.0.0.1:5100/siderolabs -test.cache-repository=127.0.0.1:5100/image-factory/cache -test.signing-cache-repository=127.0.0.1:5100/image-factory/signing-cache"
---
kind: custom.Step
name: integration-proxy-installer
spec:
  makefile:
    enabled: true
    phony: true
    depends:
      - integration.test
    variables:
      - name: RUN_TESTS_PROXY
        defaultValue: TestIntegrationDirect
      - name: TEST_FLAGS
        defaultValue: ""
    script:
      - "@$(MAKE) image-image-factory PUSH=true"
      - docker pull $(REGISTRY)/$(USERNAME)/image-factory:$(TAG)
      - docker rm -f local-if || true
      - docker run -d -p 5100:5000 --name=local-if registry:3
      - docker run --rm --net=host -v /var/run:/var/run -v $(PWD)/$(ARTIFACTS)/:/out/ -v $(PWD)/$(ARTIFACTS)/integration.test:/bin/integration.test:ro --entrypoint /bin/integration.test $(REGISTRY)/$(USERNAME)/image-factory:$(TAG) -test.v $(TEST_FLAGS) -test.coverprofile=/out/coverage-integration-direct.txt -test.run $(RUN_TESTS_PROXY)
      - docker rm -f local-if
  ghaction:
    enabled: true
    condition: on-pull-request
    parallelJob:
      name: integration-proxy-installer
      runnerGroup: generic
    coverage:
      inputPaths:
        - coverage-integration-proxy-installer.txt
    environment:
      REGISTRY: registry.dev.siderolabs.io
      RUN_TESTS_PROXY: TestIntegrationDirect
      TEST_FLAGS: "-test.schematic-service-repository=127.0.0.1:5100/image-factory/schematic -test.installer-internal-repository=127.0.0.1:5100/siderolabs -test.cache-repository=127.0.0.1:5100/image-factory/cache -test.signing-cache-repository=127.0.0.1:5100/image-factory/signing-cache"
---
kind: custom.Step
name: integration-enterprise
spec:
  makefile:
    enabled: true
    phony: true
    depends:
      - integration.enterprise.test
    variables:
      - name: RUN_TESTS_ENTERPRISE
        defaultValue: TestIntegrationDirect
      - name: TEST_FLAGS
        defaultValue: ""
    script:
      - "@$(MAKE) image-image-factory PUSH=true"
      - docker pull $(REGISTRY)/$(USERNAME)/image-factory:$(TAG)
      - docker rm -f local-if || true
      - docker run -d -p 5100:5000 --name=local-if registry:3
      - docker run --rm --net=host -v /var/run:/var/run -v $(PWD)/$(ARTIFACTS)/:/out/ -v $(PWD)/$(ARTIFACTS)/integration.enterprise.test:/bin/integration.test:ro --entrypoint /bin/integration.test $(REGISTRY)/$(USERNAME)/image-factory:$(TAG) -test.v $(TEST_FLAGS) -test.coverprofile=/out/coverage-integration-enterprise.txt -test.run $(RUN_TESTS_ENTERPRISE)
      - docker rm -f local-if
  ghaction:
    enabled: true
    condition: on-pull-request
    parallelJob:
      name: integration-enterprise
      runnerGroup: generic
    coverage:
      inputPaths:
        - coverage-integration-enterprise.txt
    environment:
      REGISTRY: registry.dev.siderolabs.io
      RUN_TESTS_ENTERPRISE: TestIntegrationDirect
      TEST_FLAGS: "-test.schematic-service-repository=127.0.0.1:5100/image-factory/schematic -test.installer-internal-repository=127.0.0.1:5100/siderolabs -test.cache-repository=127.0.0.1:5100/image-factory/cache -test.signing-cache-repository=127.0.0.1:5100/image-factory/signing-cache"
      TAG_SUFFIX: "-enterprise"
---
kind: custom.Step
name: integration-direct-talos-main
spec:
  makefile:
    enabled: true
    phony: true
    depends:
      - update-to-talos-main
    script:
      - "@$(MAKE) integration-direct"
  ghaction:
    enabled: true
    cronOnly: true
    environment:
      REGISTRY: registry.dev.siderolabs.io
      RUN_TESTS_DIRECT: TestIntegrationDirect
      TEST_FLAGS: "-test.schematic-service-repository=registry.dev.siderolabs.io/image-factory/schematic -test.installer-external-repository=registry.dev.siderolabs.io/siderolabs -test.installer-internal-repository=registry.dev.siderolabs.io/siderolabs -test.cache-repository=registry.dev.siderolabs.io/image-factory/cache -test.signing-cache-repository=127.0.0.1:5100/image-factory/signing-cache"
    jobs:
      - name: integration-direct-talos-main
        runnerGroup: generic
        triggerLabels:
          - integration/talos-main
        crons:
          - "30 7 * * *"
---
kind: custom.Step
name: integration-s3-talos-main
spec:
  makefile:
    enabled: true
    phony: true
    depends:
      - update-to-talos-main
    script:
      - "@$(MAKE) integration-s3"
  ghaction:
    enabled: true
    cronOnly: true
    environment:
      REGISTRY: registry.dev.siderolabs.io
      RUN_TESTS_S3: TestIntegrationS3
      TEST_FLAGS: "-test.schematic-service-repository=registry.dev.siderolabs.io/image-factory/schematic -test.installer-external-repository=registry.dev.siderolabs.io/siderolabs -test.installer-internal-repository=registry.dev.siderolabs.io/siderolabs -test.cache-repository=registry.dev.siderolabs.io/image-factory/cache -test.signing-cache-repository=127.0.0.1:5100/image-factory/signing-cache"
    jobs:
      - name: integration-s3-talos-main
        runnerGroup: generic
        triggerLabels:
          - integration/talos-main
        crons:
          - "30 7 * * *"
---
kind: custom.Step
name: integration-cdn-talos-main
spec:
  makefile:
    enabled: true
    phony: true
    depends:
      - update-to-talos-main
    script:
      - "@$(MAKE) integration-cdn"
  ghaction:
    enabled: true
    cronOnly: true
    environment:
      REGISTRY: registry.dev.siderolabs.io
      RUN_TESTS_CDN: TestIntegrationCDN
      TEST_FLAGS: "-test.schematic-service-repository=registry.dev.siderolabs.io/image-factory/schematic -test.installer-external-repository=registry.dev.siderolabs.io/siderolabs -test.installer-internal-repository=registry.dev.siderolabs.io/siderolabs -test.cache-repository=registry.dev.siderolabs.io/image-factory/cache -test.signing-cache-repository=127.0.0.1:5100/image-factory/signing-cache"
    jobs:
      - name: integration-cdn-talos-main
        runnerGroup: generic
        triggerLabels:
          - integration/talos-main
        crons:
          - "30 7 * * *"
---
kind: custom.Step
name: docker-compose-up
spec:
  makefile:
    enabled: true
    phony: true
    script:
      - "@$(MAKE) image-image-factory PUSH=true"
      - "@IMAGE_FACTORY_IMAGE=$(REGISTRY)/$(USERNAME)/image-factory:$(IMAGE_TAG) docker compose -f hack/dev/compose.yaml up --pull=always --remove-orphans --no-attach registry.local --no-attach registry.ghcr.io"
---
kind: custom.Step
name: docker-compose-down
spec:
  makefile:
    enabled: true
    phony: true
    script:
      - "@IMAGE_FACTORY_IMAGE=$(REGISTRY)/$(USERNAME)/image-factory:$(IMAGE_TAG) docker compose -f hack/dev/compose.yaml down"
---
kind: common.Build
spec:
  ignoredPaths:
    - node_modules/
---
kind: service.CodeCov
spec:
  targetThreshold: 50
---
kind: custom.Step
name: tailwind
spec:
  makefile:
    enabled: true
    phony: true
    script:
      - "@$(MAKE) local-tailwind-copy PUSH=false DEST=. PLATFORM=$(OPERATING_SYSTEM)/$(GOARCH)"
  docker:
    description: "Runs tailwind update"
    enabled: true
    stages:
      - name: tailwind-base
        description: "Installs tailwindcss"
        from: docker.io/oven/bun:1.2.4-alpine
        platform: "${BUILDPLATFORM}"
        workdir: /src
        steps:
          - copy:
              src: package.json package-lock.json
              dst: .
          - script:
              command: bun install
      - name: tailwind-update
        description: "tailwind update"
        from: tailwind-base
        steps:
          - copy:
              src: tailwind.config.js
              dst: .
          - copy:
              src: internal/frontend/http
              dst: internal/frontend/http
          - script:
              command: node_modules/.bin/tailwindcss -i internal/frontend/http/css/input.css -o internal/frontend/http/css/output.css --minify
      - name: tailwind-copy
        description: "Copies assets"
        steps:
          - copy:
              from: tailwind-update
              src: /src/internal/frontend/http/css/output.css
              dst: internal/frontend/http/css/output.css
---
kind: common.Repository
spec:
  licenses:
    - id: MPL-2.0
      header: |
        // This Source Code Form is subject to the terms of the Mozilla Public
        // License, v. 2.0. If a copy of the MPL was not distributed with this
        // file, You can obtain one at http://mozilla.org/MPL/2.0/.

    - id: BSL-1.1
      root: enterprise
      params:
        Licensor: Sidero Labs, Inc.
        LicensedWork: Image Factory
        Copyright: (c) 2025 Sidero Labs, Inc.
        ChangeDate: "2029-12-08"
        ChangeLicense: Mozilla Public License, version 2.0
        EnterpriseLink: https://www.siderolabs.com/contact/
      header: |
        // Copyright (c) 2025 Sidero Labs, Inc.
        //
        // Use of this software is governed by the Business Source License
        // included in the LICENSE file.
  licenseChecks:
    - root: "."
      header: |
        // This Source Code Form is subject to the terms of the Mozilla Public
        // License, v. 2.0. If a copy of the MPL was not distributed with this
        // file, You can obtain one at http://mozilla.org/MPL/2.0/
      includeSuffixes:
        - .go
      excludeSuffixes:
        - .pb.go
        - .pb.gw.go
      skipPaths:
        - enterprise/

    - root: enterprise
      header: |
        // Copyright (c) 2025 Sidero Labs, Inc.
        //
        // Use of this software is governed by the Business Source License
        // included in the LICENSE file.
      includeSuffixes:
        - .go
      excludeSuffixes:
        - .pb.go
        - .pb.gw.go
---
kind: custom.Step
name: docs
spec:
  docker:
    enabled: true
    stages:
      - name: docgen
        description: run the docgen
        from: base
        steps:
          - script:
              command: go run ./tools/docgen ./cmd/image-factory/cmd/options.go docs/configuration.md
              cache:
                - /root/.cache/go-build
                - /go/pkg
      - name: docs
        description: copies out the generated docs
        steps:
          - copy:
              from: docgen
              src: /src/docs/configuration.md
              dst: /configuration.md
  makefile:
    enabled: true
    phony: true
    script:
      - "@$(MAKE) local-$@ DEST=docs"
  ghaction:
    enabled: true
    condition: on-pull-request
---
kind: custom.Step
name: check-dirty
spec:
  makefile:
    enabled: true
    phony: true
    script:
      - |
        @if test -n "`git status --porcelain`"; then echo "Source tree is dirty"; git status; git diff; exit 1 ; fi
  ghaction:
    enabled: true
    condition: on-pull-request
