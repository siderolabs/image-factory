suite: Ingress Logic
templates:
  - ingress-ui.yaml
  - ingress-pxe.yaml

tests:
  # ========================================
  # UI Ingress Tests
  # ========================================
  - it: Should not create UI ingress by default
    template: ingress-ui.yaml
    capabilities:
      majorVersion: 1
      minorVersion: 19
    asserts:
      - hasDocuments:
          count: 0

  - it: Should not create UI ingress when explicitly disabled
    template: ingress-ui.yaml
    capabilities:
      majorVersion: 1
      minorVersion: 19
    set:
      ingress:
        ui:
          enabled: false
    asserts:
      - hasDocuments:
          count: 0

  - it: Should create UI ingress when enabled
    template: ingress-ui.yaml
    capabilities:
      majorVersion: 1
      minorVersion: 19
    set:
      ingress:
        ui:
          enabled: true
          host: factory.example.com
    asserts:
      - hasDocuments:
          count: 1
      - isKind:
          of: Ingress
      - equal:
          path: metadata.name
          value: RELEASE-NAME-image-factory-ui

  - it: Should render UI Ingress with default settings for Kubernetes >=1.19
    template: ingress-ui.yaml
    capabilities:
      majorVersion: 1
      minorVersion: 19
    set:
      ingress:
        ui:
          enabled: true
          host: factory.example.com
    asserts:
      - equal:
          path: apiVersion
          value: networking.k8s.io/v1
      - isKind:
          of: Ingress
      - equal:
          path: spec.rules[0].host
          value: factory.example.com

  - it: Should configure UI ingress hostname
    template: ingress-ui.yaml
    capabilities:
      majorVersion: 1
      minorVersion: 19
    set:
      ingress:
        ui:
          enabled: true
          host: factory.example.com
    asserts:
      - equal:
          path: spec.rules[0].host
          value: factory.example.com

  - it: Should configure UI ingress className
    template: ingress-ui.yaml
    capabilities:
      majorVersion: 1
      minorVersion: 19
    set:
      ingress:
        ui:
          enabled: true
          host: factory.example.com
          className: nginx
    asserts:
      - equal:
          path: spec.ingressClassName
          value: nginx

  - it: Should configure UI ingress TLS
    template: ingress-ui.yaml
    capabilities:
      majorVersion: 1
      minorVersion: 19
    set:
      ingress:
        ui:
          enabled: true
          host: factory.example.com
          tls:
            - secretName: factory-ui-tls
              hosts:
                - factory.example.com
    asserts:
      - equal:
          path: spec.tls[0].secretName
          value: factory-ui-tls
      - contains:
          path: spec.tls[0].hosts
          content: factory.example.com

  - it: Should add UI ingress custom annotations
    template: ingress-ui.yaml
    capabilities:
      majorVersion: 1
      minorVersion: 19
    set:
      ingress:
        ui:
          enabled: true
          host: factory.example.com
          annotations:
            cert-manager.io/cluster-issuer: letsencrypt-prod
            nginx.ingress.kubernetes.io/ssl-redirect: "true"
    asserts:
      - equal:
          path: metadata.annotations["cert-manager.io/cluster-issuer"]
          value: letsencrypt-prod
      - equal:
          path: metadata.annotations["nginx.ingress.kubernetes.io/ssl-redirect"]
          value: "true"

  - it: Should add UI ingress custom labels
    template: ingress-ui.yaml
    capabilities:
      majorVersion: 1
      minorVersion: 19
    set:
      ingress:
        ui:
          enabled: true
          host: factory.example.com
          labels:
            environment: production
            team: platform
    asserts:
      - equal:
          path: metadata.labels.environment
          value: production
      - equal:
          path: metadata.labels.team
          value: platform

  - it: Should configure UI ingress backend service
    template: ingress-ui.yaml
    capabilities:
      majorVersion: 1
      minorVersion: 19
    set:
      ingress:
        ui:
          enabled: true
          host: factory.example.com
      service:
        main:
          port: 8080
    asserts:
      - equal:
          path: spec.rules[0].http.paths[0].backend.service.name
          value: RELEASE-NAME-image-factory
      - equal:
          path: spec.rules[0].http.paths[0].backend.service.port.number
          value: 8080

  # ========================================
  # PXE Ingress Tests
  # ========================================
  - it: Should not create PXE ingress by default
    template: ingress-pxe.yaml
    capabilities:
      majorVersion: 1
      minorVersion: 19
    asserts:
      - hasDocuments:
          count: 0

  - it: Should not create PXE ingress when explicitly disabled
    template: ingress-pxe.yaml
    capabilities:
      majorVersion: 1
      minorVersion: 19
    set:
      ingress:
        pxe:
          enabled: false
    asserts:
      - hasDocuments:
          count: 0

  - it: Should create PXE ingress when enabled
    template: ingress-pxe.yaml
    capabilities:
      majorVersion: 1
      minorVersion: 19
    set:
      ingress:
        pxe:
          enabled: true
          host: pxe-factory.example.com
    asserts:
      - hasDocuments:
          count: 1
      - isKind:
          of: Ingress
      - equal:
          path: metadata.name
          value: RELEASE-NAME-image-factory-pxe

  - it: Should render PXE Ingress with default settings for Kubernetes >=1.19
    template: ingress-pxe.yaml
    capabilities:
      majorVersion: 1
      minorVersion: 19
    set:
      ingress:
        pxe:
          enabled: true
          host: pxe-factory.example.com
    asserts:
      - equal:
          path: apiVersion
          value: networking.k8s.io/v1
      - isKind:
          of: Ingress
      - equal:
          path: spec.rules[0].host
          value: pxe-factory.example.com

  - it: Should configure PXE ingress hostname
    template: ingress-pxe.yaml
    capabilities:
      majorVersion: 1
      minorVersion: 19
    set:
      ingress:
        pxe:
          enabled: true
          host: pxe-factory.example.com
    asserts:
      - equal:
          path: spec.rules[0].host
          value: pxe-factory.example.com

  - it: Should configure PXE ingress className
    template: ingress-pxe.yaml
    capabilities:
      majorVersion: 1
      minorVersion: 19
    set:
      ingress:
        pxe:
          enabled: true
          host: pxe-factory.example.com
          className: nginx
    asserts:
      - equal:
          path: spec.ingressClassName
          value: nginx

  - it: Should configure PXE ingress TLS
    template: ingress-pxe.yaml
    capabilities:
      majorVersion: 1
      minorVersion: 19
    set:
      ingress:
        pxe:
          enabled: true
          host: pxe-factory.example.com
          tls:
            - secretName: factory-pxe-tls
              hosts:
                - pxe-factory.example.com
    asserts:
      - equal:
          path: spec.tls[0].secretName
          value: factory-pxe-tls
      - contains:
          path: spec.tls[0].hosts
          content: pxe-factory.example.com

  - it: Should add PXE ingress custom annotations
    template: ingress-pxe.yaml
    capabilities:
      majorVersion: 1
      minorVersion: 19
    set:
      ingress:
        pxe:
          enabled: true
          host: pxe-factory.example.com
          annotations:
            cert-manager.io/cluster-issuer: letsencrypt-prod
    asserts:
      - equal:
          path: metadata.annotations["cert-manager.io/cluster-issuer"]
          value: letsencrypt-prod

  - it: Should add PXE ingress custom labels
    template: ingress-pxe.yaml
    capabilities:
      majorVersion: 1
      minorVersion: 19
    set:
      ingress:
        pxe:
          enabled: true
          host: pxe-factory.example.com
          labels:
            environment: production
    asserts:
      - equal:
          path: metadata.labels.environment
          value: production
  - it: Should render UI Ingress with non-default settings for Kubernetes >=1.19
    template: ingress-ui.yaml
    capabilities:
      majorVersion: 1
      minorVersion: 19
    set:
      ingress:
        ui:
          enabled: true
          className: nginx
          host: factory.example.com
          annotations:
            nginx.ingress.kubernetes.io/ssl-redirect: "true"
            cert-manager.io/cluster-issuer: letsencrypt-prod
          labels:
            environment: production
          tls:
            - secretName: factory-ui-tls
              hosts:
                - factory.example.com
    asserts:
      - equal:
          path: apiVersion
          value: networking.k8s.io/v1
      - equal:
          path: spec.ingressClassName
          value: nginx
      - equal:
          path: metadata.annotations["nginx.ingress.kubernetes.io/ssl-redirect"]
          value: "true"
      - equal:
          path: metadata.annotations["cert-manager.io/cluster-issuer"]
          value: letsencrypt-prod
      - equal:
          path: metadata.labels.environment
          value: production
      - equal:
          path: spec.tls[0].secretName
          value: factory-ui-tls
      - contains:
          path: spec.tls[0].hosts
          content: factory.example.com
  - it: Should render PXE Ingress with non-default settings for Kubernetes >=1.19
    template: ingress-pxe.yaml
    capabilities:
      majorVersion: 1
      minorVersion: 19
    set:
      ingress:
        pxe:
          enabled: true
          className: nginx
          host: pxe-factory.example.com
          annotations:
            nginx.ingress.kubernetes.io/ssl-redirect: "false"
            nginx.ingress.kubernetes.io/backend-protocol: "HTTP"
          labels:
            environment: production
            service: pxe
          tls:
            - secretName: factory-pxe-tls
              hosts:
                - pxe-factory.example.com
    asserts:
      - equal:
          path: apiVersion
          value: networking.k8s.io/v1
      - equal:
          path: spec.ingressClassName
          value: nginx
      - equal:
          path: metadata.annotations["nginx.ingress.kubernetes.io/ssl-redirect"]
          value: "false"
      - equal:
          path: metadata.annotations["nginx.ingress.kubernetes.io/backend-protocol"]
          value: "HTTP"
      - equal:
          path: metadata.labels.environment
          value: production
      - equal:
          path: metadata.labels.service
          value: pxe
      - equal:
          path: spec.tls[0].secretName
          value: factory-pxe-tls

  - it: Should configure PXE ingress backend service
    template: ingress-pxe.yaml
    capabilities:
      majorVersion: 1
      minorVersion: 19
    set:
      ingress:
        pxe:
          enabled: true
          host: pxe-factory.example.com
      service:
        main:
          port: 8080
    asserts:
      - equal:
          path: spec.rules[0].http.paths[0].backend.service.name
          value: RELEASE-NAME-image-factory
      - equal:
          path: spec.rules[0].http.paths[0].backend.service.port.number
          value: 8080