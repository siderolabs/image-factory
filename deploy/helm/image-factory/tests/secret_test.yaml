suite: Cache Signing Key Secret Logic
templates:
  - secret-cache-signing-key.yaml

tests:
  # ========================================
  # Secret Creation Tests
  # ========================================
  - it: Should create secret when existingSecret is not set
    template: secret-cache-signing-key.yaml
    set:
      cacheSigningKey:
        existingSecret: ""
        key: |-
          -----BEGIN EC PRIVATE KEY-----
          MHcCAQEEIExampleKeyContent...
          -----END EC PRIVATE KEY-----
    asserts:
      - hasDocuments:
          count: 1
      - isKind:
          of: Secret
      - equal:
          path: metadata.name
          value: RELEASE-NAME-image-factory-cache-signing-key

  - it: Should not create secret when existingSecret is set
    template: secret-cache-signing-key.yaml
    set:
      cacheSigningKey:
        existingSecret: my-pre-existing-secret
    asserts:
      - hasDocuments:
          count: 0

  - it: Should have correct secret type
    template: secret-cache-signing-key.yaml
    set:
      cacheSigningKey:
        existingSecret: ""
        key: "test-key"
    asserts:
      - equal:
          path: type
          value: Opaque

  - it: Should store key in stringData with correct key name
    template: secret-cache-signing-key.yaml
    set:
      cacheSigningKey:
        existingSecret: ""
        key: |-
          -----BEGIN EC PRIVATE KEY-----
          MHcCAQEEIExampleKeyContent123456789...
          -----END EC PRIVATE KEY-----
    asserts:
      - isNotNull:
          path: stringData["cache-signing.key"]
      - matchRegex:
          path: stringData["cache-signing.key"]
          pattern: "-----BEGIN EC PRIVATE KEY-----"

  - it: Should include standard Helm labels
    template: secret-cache-signing-key.yaml
    set:
      cacheSigningKey:
        existingSecret: ""
        key: "test-key"
    asserts:
      - equal:
          path: metadata.labels["app.kubernetes.io/name"]
          value: image-factory
      - equal:
          path: metadata.labels["app.kubernetes.io/instance"]
          value: RELEASE-NAME
      - isNotNull:
          path: metadata.labels["helm.sh/chart"]

  - it: Should be created in correct namespace
    template: secret-cache-signing-key.yaml
    release:
      namespace: custom-namespace
    set:
      cacheSigningKey:
        existingSecret: ""
        key: "test-key"
    asserts:
      - equal:
          path: metadata.namespace
          value: custom-namespace

  # ========================================
  # Key Content Tests
  # ========================================
  - it: Should handle multiline key content correctly
    template: secret-cache-signing-key.yaml
    set:
      cacheSigningKey:
        existingSecret: ""
        key: |-
          -----BEGIN EC PRIVATE KEY-----
          Line1Content
          Line2Content
          Line3Content
          -----END EC PRIVATE KEY-----
    asserts:
      - matchRegex:
          path: stringData["cache-signing.key"]
          pattern: "Line1Content"
      - matchRegex:
          path: stringData["cache-signing.key"]
          pattern: "Line2Content"
      - matchRegex:
          path: stringData["cache-signing.key"]
          pattern: "Line3Content"