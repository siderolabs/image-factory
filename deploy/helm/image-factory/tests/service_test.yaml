suite: Service Logic
templates:
  - service.yaml
  - service-metrics.yaml
  - servicemonitor.yaml

tests:
  # ========================================
  # Main Service Tests
  # ========================================
  - it: Should create main service
    template: service.yaml
    asserts:
      - hasDocuments:
          count: 1
      - isKind:
          of: Service
      - equal:
          path: metadata.name
          value: RELEASE-NAME-image-factory

  - it: Should use ClusterIP by default
    template: service.yaml
    asserts:
      - equal:
          path: spec.type
          value: ClusterIP

  - it: Should configure main service port
    template: service.yaml
    set:
      service:
        main:
          port: 8080
    asserts:
      - equal:
          path: spec.ports[0].port
          value: 8080
      - equal:
          path: spec.ports[0].name
          value: image-factory
      - equal:
          path: spec.ports[0].targetPort
          value: http
      - equal:
          path: spec.ports[0].protocol
          value: TCP

  - it: Should configure LoadBalancer service type
    template: service.yaml
    set:
      service:
        main:
          type: LoadBalancer
    asserts:
      - equal:
          path: spec.type
          value: LoadBalancer

  - it: Should add loadBalancerIP when type is LoadBalancer
    template: service.yaml
    set:
      service:
        main:
          type: LoadBalancer
          loadBalancerIP: "1.2.3.4"
    asserts:
      - equal:
          path: spec.type
          value: LoadBalancer
      - equal:
          path: spec.loadBalancerIP
          value: "1.2.3.4"

  - it: Should not add loadBalancerIP when type is ClusterIP
    template: service.yaml
    set:
      service:
        main:
          type: ClusterIP
          loadBalancerIP: "1.2.3.4"
    asserts:
      - equal:
          path: spec.type
          value: ClusterIP
      - isNull:
          path: spec.loadBalancerIP

  - it: Should configure NodePort service type
    template: service.yaml
    set:
      service:
        main:
          type: NodePort
    asserts:
      - equal:
          path: spec.type
          value: NodePort

  - it: Should add custom service annotations
    template: service.yaml
    set:
      service:
        main:
          annotations:
            cloud.google.com/load-balancer-type: Internal
            service.beta.kubernetes.io/aws-load-balancer-internal: "true"
    asserts:
      - equal:
          path: metadata.annotations["cloud.google.com/load-balancer-type"]
          value: Internal
      - equal:
          path: metadata.annotations["service.beta.kubernetes.io/aws-load-balancer-internal"]
          value: "true"

  - it: Should add custom service labels
    template: service.yaml
    set:
      service:
        main:
          labels:
            environment: production
            team: platform
    asserts:
      - equal:
          path: metadata.labels.environment
          value: production
      - equal:
          path: metadata.labels.team
          value: platform

  - it: Should have correct selector labels
    template: service.yaml
    asserts:
      - equal:
          path: spec.selector
          value:
            app.kubernetes.io/name: image-factory
            app.kubernetes.io/instance: RELEASE-NAME

  # ========================================
  # Metrics Service Tests
  # ========================================
  - it: Should not create metrics service by default
    template: service-metrics.yaml
    asserts:
      - hasDocuments:
          count: 0

  - it: Should create metrics service when enabled
    template: service-metrics.yaml
    set:
      service:
        metrics:
          enabled: true
    asserts:
      - hasDocuments:
          count: 1
      - isKind:
          of: Service
      - equal:
          path: metadata.name
          value: RELEASE-NAME-image-factory-metrics

  - it: Should configure metrics service port
    template: service-metrics.yaml
    set:
      service:
        metrics:
          enabled: true
          service:
            servicePort: 2122
    asserts:
      - equal:
          path: spec.ports[0].port
          value: 2122
      - equal:
          path: spec.ports[0].name
          value: metrics
      - equal:
          path: spec.ports[0].targetPort
          value: metrics
      - equal:
          path: spec.ports[0].protocol
          value: TCP

  - it: Should configure metrics service type
    template: service-metrics.yaml
    set:
      service:
        metrics:
          enabled: true
          service:
            type: NodePort
    asserts:
      - equal:
          path: spec.type
          value: NodePort

  - it: Should configure metrics service clusterIP
    template: service-metrics.yaml
    set:
      service:
        metrics:
          enabled: true
          service:
            type: ClusterIP
            clusterIP: None
    asserts:
      - equal:
          path: spec.clusterIP
          value: None

  - it: Should not set clusterIP for LoadBalancer service
    template: service-metrics.yaml
    set:
      service:
        metrics:
          enabled: true
          service:
            type: LoadBalancer
            clusterIP: None
    asserts:
      - isNull:
          path: spec.clusterIP

  - it: Should add custom metrics service annotations
    template: service-metrics.yaml
    set:
      service:
        metrics:
          enabled: true
          service:
            annotations:
              prometheus.io/scrape: "true"
              prometheus.io/port: "2122"
    asserts:
      - equal:
          path: metadata.annotations["prometheus.io/scrape"]
          value: "true"
      - equal:
          path: metadata.annotations["prometheus.io/port"]
          value: "2122"

  - it: Should add custom metrics service labels
    template: service-metrics.yaml
    set:
      service:
        metrics:
          enabled: true
          service:
            labels:
              monitoring: enabled
    asserts:
      - equal:
          path: metadata.labels.monitoring
          value: enabled

  - it: Should have correct selector labels for metrics service
    template: service-metrics.yaml
    set:
      service:
        metrics:
          enabled: true
    asserts:
      - equal:
          path: spec.selector
          value:
            app.kubernetes.io/name: image-factory
            app.kubernetes.io/instance: RELEASE-NAME

  # ========================================
  # ServiceMonitor Tests
  # ========================================
  - it: Should not create ServiceMonitor by default
    template: servicemonitor.yaml
    asserts:
      - hasDocuments:
          count: 0

  - it: Should create ServiceMonitor when enabled
    template: servicemonitor.yaml
    set:
      service:
        metrics:
          enabled: true
          serviceMonitor:
            enabled: true
    asserts:
      - hasDocuments:
          count: 1
      - isKind:
          of: ServiceMonitor

  - it: Should configure ServiceMonitor to scrape metrics port
    template: servicemonitor.yaml
    set:
      service:
        metrics:
          enabled: true
          serviceMonitor:
            enabled: true
    asserts:
      - equal:
          path: spec.endpoints[0].port
          value: metrics
      - equal:
          path: spec.endpoints[0].path
          value: /metrics

  - it: Should configure ServiceMonitor interval
    template: servicemonitor.yaml
    set:
      service:
        metrics:
          enabled: true
          serviceMonitor:
            enabled: true
            interval: 60s
    asserts:
      - equal:
          path: spec.endpoints[0].interval
          value: 60s

  - it: Should configure ServiceMonitor scrapeTimeout
    template: servicemonitor.yaml
    set:
      service:
        metrics:
          enabled: true
          serviceMonitor:
            enabled: true
            scrapeTimeout: 30s
    asserts:
      - equal:
          path: spec.endpoints[0].scrapeTimeout
          value: 30s